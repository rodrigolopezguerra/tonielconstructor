<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lego Builder 3.0 - Configurable</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* UI Overlay */
        #ui-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .color-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .color-btn.selected { border: 3px solid #333; transform: scale(1.15); }

        #tools {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-btn {
            width: 55px;
            height: 55px;
            background: white;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .tool-btn:active { transform: scale(0.95); }
        .tool-btn.active { background-color: #ffcccc; color: red; border: 2px solid red; }

        /* Estilos para Modales (Carga y Configuraci√≥n) */
        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 20;
            width: 85%;
            max-width: 320px;
            max-height: 75%;
            overflow-y: auto;
            text-align: center;
        }
        
        .modal h2 { margin-top: 0; color: #333; font-size: 1.5rem; }
        .modal label { display: block; margin: 15px 0 5px; font-weight: bold; text-align: left; }
        
        /* Estilos espec√≠ficos de Configuraci√≥n */
        select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            background: #f9f9f9;
        }

        /* Estilos lista guardado */
        .saved-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .btn-primary {
            background: #2196F3; color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px;
        }
        
        .btn-action { padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; color: white; }
        .btn-load { background: #4CAF50; flex-grow: 1; margin-right: 5px; }
        .btn-delete { background: #ff5252; }

        .close-modal-btn {
            margin-top: 15px;
            background: transparent;
            border: 1px solid #ccc;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            color: #666;
        }

        #overlay-bg {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 15;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="overlay-bg"></div>

    <div id="load-modal" class="modal">
        <h2>Mis Construcciones</h2>
        <div id="saved-list"></div>
        <button class="close-modal-btn" onclick="closeAllModals()">Cerrar</button>
    </div>

    <div id="settings-modal" class="modal">
        <h2>‚öôÔ∏è Configuraci√≥n</h2>
        
        <label for="map-size">Tama√±o del Mapa:</label>
        <select id="map-size">
            <option value="1000">Normal (20x20)</option>
            <option value="2000">Grande (40x40)</option>
            <option value="3000">Enorme (60x60)</option>
        </select>

        <button class="btn-primary" onclick="saveSettings()">Guardar y Aplicar</button>
        <button class="close-modal-btn" onclick="closeAllModals()">Cancelar</button>
    </div>

    <div id="tools">
        <button id="btn-settings" class="tool-btn" title="Configuraci√≥n">‚öôÔ∏è</button>
        <button id="btn-save" class="tool-btn" title="Guardar">üíæ</button>
        <button id="btn-load" class="tool-btn" title="Cargar">üìÇ</button>
        <button id="btn-mode" class="tool-btn" title="Borrar Bloques">üóëÔ∏è</button>
        <button id="btn-clear" class="tool-btn" title="Limpiar Todo">üîÑ</button>
    </div>

    <div id="ui-container">
        <div class="color-btn selected" style="background-color: #d32f2f;" onclick="setColor(this, 0xd32f2f)"></div>
        <div class="color-btn" style="background-color: #1976d2;" onclick="setColor(this, 0x1976d2)"></div>
        <div class="color-btn" style="background-color: #fbc02d;" onclick="setColor(this, 0xfbc02d)"></div>
        <div class="color-btn" style="background-color: #388e3c;" onclick="setColor(this, 0x388e3c)"></div>
        <div class="color-btn" style="background-color: #9c27b0;" onclick="setColor(this, 0x9c27b0)"></div>
        <div class="color-btn" style="background-color: #fff;" onclick="setColor(this, 0xffffff)"></div>
        <div class="color-btn" style="background-color: #212121;" onclick="setColor(this, 0x212121)"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let camera, scene, renderer;
        let plane, gridHelper;
        let pointer, raycaster;
        let isShiftDown = false; 
        
        let rollOverMesh, rollOverMaterial;
        let cubeGeo;
        
        // objects[0] siempre ser√° el plano del suelo
        let objects = []; 
        
        let currentColor = 0xd32f2f;
        
        // Configuraci√≥n por defecto
        let appSettings = {
            mapSize: 1000
        };

        init();
        render();

        function init() {
            // Cargar configuraci√≥n guardada
            loadSettingsFromStorage();

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.set(500, 800, 1300);
            camera.lookAt(0, 0, 0);

            // Luces
            const ambientLight = new THREE.AmbientLight(0x606060, 3);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 3);
            directionalLight.position.set(1, 0.75, 0.5).normalize();
            scene.add(directionalLight);

            // Cursor Fantasma
            const rollOverGeo = new THREE.BoxGeometry(50, 50, 50);
            rollOverMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, opacity: 0.5, transparent: true });
            rollOverMesh = new THREE.Mesh(rollOverGeo, rollOverMaterial);
            scene.add(rollOverMesh);

            cubeGeo = new THREE.BoxGeometry(50, 50, 50);
            
            // CREAR EL ENTORNO (Grid y Suelo) basado en configuraci√≥n
            updateEnvironment(appSettings.mapSize);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            raycaster = new THREE.Raycaster();
            pointer = new THREE.Vector2();

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2 - 0.05; // Evitar que la c√°mara pase bajo el suelo

            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerdown', onPointerDown);
            window.addEventListener('resize', onWindowResize);

            setupUI();
        }

        // --- GESTI√ìN DEL ENTORNO Y CONFIGURACI√ìN ---

        function updateEnvironment(size) {
            // Limpiar grid y plano anteriores si existen
            if (gridHelper) scene.remove(gridHelper);
            if (plane) scene.remove(plane);
            
            // Si el plano estaba en objects[0], quitarlo
            if (objects.length > 0 && objects[0].isPlane) {
                objects.shift(); 
            }

            // Crear nuevo Grid
            // Size = tama√±o total, 50 = tama√±o de cada celda
            gridHelper = new THREE.GridHelper(size, size / 50);
            scene.add(gridHelper);

            // Crear nuevo Plano de Raycasting (invisible)
            const geometry = new THREE.PlaneGeometry(size, size);
            geometry.rotateX(-Math.PI / 2);
            plane = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({ visible: false }));
            plane.isPlane = true; // Marca para identificarlo
            scene.add(plane);
            
            // Insertar el plano al principio del array de objetos
            objects.unshift(plane);
        }

        function loadSettingsFromStorage() {
            const saved = localStorage.getItem('legoSettings');
            if (saved) {
                appSettings = JSON.parse(saved);
                // Actualizar selector UI
                document.getElementById('map-size').value = appSettings.mapSize;
            }
        }

        window.saveSettings = function() {
            const sizeSelect = document.getElementById('map-size');
            const newSize = parseInt(sizeSelect.value);

            appSettings.mapSize = newSize;
            localStorage.setItem('legoSettings', JSON.stringify(appSettings));
            
            updateEnvironment(newSize);
            closeAllModals();
            render();
            alert("¬°Configuraci√≥n guardada y aplicada!");
        }

        // --- UI SETUP ---

        function setupUI() {
            const btnMode = document.getElementById('btn-mode');
            btnMode.addEventListener('click', (e) => {
                e.stopPropagation();
                isShiftDown = !isShiftDown;
                if(isShiftDown) {
                    btnMode.classList.add('active');
                    rollOverMesh.visible = false;
                } else {
                    btnMode.classList.remove('active');
                    rollOverMesh.visible = true;
                }
            });

            document.getElementById('btn-clear').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("¬øBorrar todo el escenario?")) clearScene();
            });

            document.getElementById('btn-save').addEventListener('click', (e) => {
                e.stopPropagation();
                saveScene();
            });

            document.getElementById('btn-load').addEventListener('click', (e) => {
                e.stopPropagation();
                openModal('load-modal');
                loadSavedList();
            });

            // Nuevo bot√≥n Settings
            document.getElementById('btn-settings').addEventListener('click', (e) => {
                e.stopPropagation();
                openModal('settings-modal');
            });
        }

        // --- MODALES ---
        
        window.openModal = function(id) {
            document.getElementById('overlay-bg').style.display = 'block';
            document.getElementById(id).style.display = 'block';
        }

        window.closeAllModals = function() {
            document.getElementById('overlay-bg').style.display = 'none';
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        // --- GUARDADO / CARGA ---

        function saveScene() {
            if (objects.length <= 1) {
                alert("¬°Construye algo primero!");
                return;
            }
            let saveName = prompt("Nombre de tu construcci√≥n:", "Mi Lego 1");
            if (!saveName) return;

            const sceneData = [];
            // Ignoramos objects[0] que es el plano
            for (let i = 1; i < objects.length; i++) {
                const obj = objects[i];
                sceneData.push({
                    x: obj.position.x, y: obj.position.y, z: obj.position.z,
                    color: obj.material.color.getHex()
                });
            }

            const savedGames = JSON.parse(localStorage.getItem('legoSaves') || '{}');
            savedGames[saveName] = sceneData;
            localStorage.setItem('legoSaves', JSON.stringify(savedGames));
            alert("¬°Guardado!");
        }

        function loadSavedList() {
            const listDiv = document.getElementById('saved-list');
            listDiv.innerHTML = '';
            const savedGames = JSON.parse(localStorage.getItem('legoSaves') || '{}');
            const keys = Object.keys(savedGames);

            if (keys.length === 0) listDiv.innerHTML = '<p>No hay nada guardado.</p>';
            else {
                keys.forEach(key => {
                    const row = document.createElement('div');
                    row.className = 'saved-item';
                    row.innerHTML = `
                        <button class="btn-action btn-load" onclick="loadScene('${key}')">${key}</button>
                        <button class="btn-action btn-delete" onclick="deleteSave('${key}')">üóëÔ∏è</button>
                    `;
                    listDiv.appendChild(row);
                });
            }
        }

        window.loadScene = function(key) {
            const savedGames = JSON.parse(localStorage.getItem('legoSaves') || '{}');
            const data = savedGames[key];
            if (data) {
                clearScene();
                data.forEach(d => {
                    const voxel = new THREE.Mesh(cubeGeo, new THREE.MeshLambertMaterial({ color: d.color }));
                    voxel.position.set(d.x, d.y, d.z);
                    scene.add(voxel);
                    objects.push(voxel);
                });
                closeAllModals();
                render();
            }
        }

        window.deleteSave = function(key) {
            if(confirm(`¬øBorrar "${key}"?`)) {
                const savedGames = JSON.parse(localStorage.getItem('legoSaves') || '{}');
                delete savedGames[key];
                localStorage.setItem('legoSaves', JSON.stringify(savedGames));
                loadSavedList();
            }
        }

        function clearScene() {
            for (let i = objects.length - 1; i > 0; i--) {
                scene.remove(objects[i]);
                objects.pop();
            }
            render();
        }

        // --- CORE ---

        window.setColor = function(element, hexColor) {
            currentColor = hexColor;
            rollOverMaterial.color.setHex(hexColor);
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            render();
        }

        function onPointerMove(event) {
            pointer.set((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1);
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(objects, false);

            if (intersects.length > 0 && !isShiftDown) {
                const intersect = intersects[0];
                rollOverMesh.position.copy(intersect.point).add(intersect.face.normal);
                rollOverMesh.position.divideScalar(50).floor().multiplyScalar(50).addScalar(25);
                render();
            }
        }

        function onPointerDown(event) {
            if(event.target.closest('.tool-btn') || event.target.closest('#ui-container') || event.target.closest('.modal')) return;

            pointer.set((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1);
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(objects, false);

            if (intersects.length > 0) {
                const intersect = intersects[0];
                if (isShiftDown) {
                    if (intersect.object !== plane) {
                        scene.remove(intersect.object);
                        objects.splice(objects.indexOf(intersect.object), 1);
                    }
                } else {
                    const voxel = new THREE.Mesh(cubeGeo, new THREE.MeshLambertMaterial({ color: currentColor }));
                    voxel.position.copy(intersect.point).add(intersect.face.normal);
                    voxel.position.divideScalar(50).floor().multiplyScalar(50).addScalar(25);
                    scene.add(voxel);
                    objects.push(voxel);
                }
                render();
            }
        }

        function render() {
            renderer.render(scene, camera);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
